{extend name="../../common/view/layout_base"}
{block name="main"}
<div class="row">
    <div class="col-sm-12">
        <blockquote class="text-warning">
            <h2>线下会员卡消费主页</h2>
        </blockquote>
        <hr>
    </div>
</div>
<div class="row">
    <div class="col-sm-4">
        <div class="ibox">
            <div class="ibox-title">线下会员卡消费</div>
            <div class="ibox-content">
                <blockquote class="text-warning" style="font-size:14px">
                    扣款操作
                </blockquote>
                <form class="form-horizontal" id="form-offline">
                    <div class="form-group">
                        <label class="col-sm-4 control-label" for="order_type">订单类型</label>
                        <div class="col-sm-8">
                            <select class="form-control" name="order_type" id="order_type" required>
                                <option value="">请选择订单类型</option>
                                {volist name="$order->ot_name" id="name"}
                                {neq name="$key" value="2"}
                                <option value="{$key}">
                                {$name}{eq name="$key" value="1"}（开发中）{/eq}
                                </option>
                                {/neq}
                                {/volist}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label" for="payment_code">付款码</label>
                        <div class="col-sm-8">
                            <input type="text" name="payment_code" id="payment_code" class="form-control" required value=""
                                   placeholder="输入用户付款码">
                            <p class="form-control-static text-danger">可使用扫码枪扫描自动输入，或者手动填写</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">总金额</label>
                        <div class="col-sm-8 ">
                            <div class="input-group">
                                <input class="form-control text-right" required type="text"
                                       value="{$order->total_money ?? ''}"
                                       name="total_money" id="total_money"
                                       placeholder="商品总金额" readonly>
                                <span class="input-group-btn">
                                    <button class="btn btn-success" type="button" id="manual">手动输入</button>
                                </span>
                            </div>
                            <p class="form-control-static text-warning">实际扣款金额依据总金额与会员卡的具体优惠方式，由后台计算自动扣除！</p>
                        </div>
                    </div>
                    <div class="form-group order_type_1" style="display: none;">
                        <label class="col-sm-4 control-label">商品</label>
                        <div class="col-sm-8 ">
                            <input class="form-control" type="text" value="" name="goods_name"
                                   id="goods_name"
                                   placeholder="请从右侧选择商品" readonly>
                            <input type="hidden" name="goods_id" id="goods_id">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">商品单价</label>
                        <div class="col-sm-8 ">
                            <div class="input-group">
                                <input class="form-control text-right calculate-price" type="text"
                                       value="{$order->goods_price ?? ''}"
                                       name="goods_price"
                                       id="goods_price"
                                       required
                                       readonly
                                       placeholder="商品单价">
                                <span class="input-group-addon"><i class="fa fa-yen-sign"></i></span>
                            </div>
                            <p class="form-control-static ">记录</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">商品数量</label>
                        <div class="col-sm-8 ">
                            <input class="form-control calculate-price" type="text" value="{$order->goods_number ?? ''}" name="goods_number" id="goods_number"
                                   placeholder="购买商品数量" required 	digits="digits" min="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label" for="remark">备注信息</label>
                        <div class="col-sm-8 ">
                            <input class="form-control " type="text" value="" name="remark" id="remark"
                                   placeholder="扣款备注信息">
                            <p class="form-control-static text-danger">如使用线下直扣方式，则必须填写!</p>
                        </div>
                    </div>
                    <div class="hr-line-dashed"></div>
                    <div class="form-group operation">
                        <div class="col-sm-4  col-sm-offset-2">
                            <button class="btn btn-primary" type="submit">确认扣款</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-sm-8" id="member_info">
    </div>
</div>
{/block}
{block name="footer_js"}
<div class="modal inmodal" id="grant_card" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content animated fadeInDown">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span
                        class="sr-only">关闭</span>
                </button>
                <h4 class="modal-title">测试</h4>
                <!--<small class="font-bold">这里可以显示副标题。</small>-->
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary">提交</button>
            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        $("#order_type").on('change', function (e) {
            let order_type_1 = $(".order_type_1");
            let goods_price = $("#goods_price");
            switch (parseInt($(this).val())) {
                case 1:
                    goods_price.prop('readonly', true);
                    order_type_1.show();
                    break;
                default:
                    order_type_1.hide();
                    goods_price.removeAttr('readonly');
            }
        });
        $(".calculate-price").on('blur', function (e) {
            let gp = $("#goods_price");
            let gn = $("#goods_number");
            let price = parseFloat(gp.val());
            let number = parseInt(gn.val());
            if(isNaN(price)) price = 0;
            if(isNaN(number)) number = 0;
            let total = (price * 100 * number) / 100;
            $("#total_money").val(total);
        });
        $("#manual").on('click', function (e) {
            let totalEle = $("#total_money");
            if(totalEle.attr("readonly") === 'readonly'){
                totalEle.removeAttr('readonly');
            }else{
                totalEle.prop('readonly', 'readonly');
            }
        });
    });
    $.validator.addMethod('isPrice', function (value, element, param) {
        if(isNaN(value)) return false;
        let number = /^[0-9]+(.[0-9]{1,2})?$/;
        return this.optional(element) || (number.test(value));
    }, '<i class="fa fa-times-circle"></i>只能填写最多2位小数点，大于0的数字！');
    $("#form-offline").validate({
        rules: {
            goods_price:{
                isPrice: !0
            },
            remark: {
                required: function (e) {
                    let order_type = $("#order_type").val();
                    return order_type === '0';
                }
            },
            goods_name: {
                required: function (e) {
                    let order_type = $("#order_type").val();
                    console.log(order_type);
                    return order_type === '1';
                }
            }
        },
        messages:{
            remark:{
                required: '<i class="fa fa-times-circle"></i>订单类型为线下直扣时，必须填写！'
            },
            goods_name: {
                required: '<i class="fa fa-times-circle"></i>订单类型为线下商品时，必须选择！'
            }
        },
        submitHandler: form => {
            $.post('__ROOT__/admin/offline/deduction', $(form).serialize(), function (res) {
                console.log(res);
            }, 'json')
        }
    });
</script>
{/block}
